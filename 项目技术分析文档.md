# 运动训练AI可视化云平台 - 技术分析文档

> **项目名称**：Sports Vision Cloud
> **项目位置**：`D:\桌面\sports-vision-cloud`
> **文档生成时间**：2025年12月14日

---

## 目录

1. [项目概述](#1-项目概述)
2. [技术栈总览](#2-技术栈总览)
3. [项目结构](#3-项目结构)
4. [架构设计](#4-架构设计)
5. [前端实现](#5-前端实现)
6. [后端实现](#6-后端实现)
7. [数据模型设计](#7-数据模型设计)
8. [API接口设计](#8-api接口设计)
9. [业务流程](#9-业务流程)
10. [部署方案](#10-部署方案)
11. [项目亮点与总结](#11-项目亮点与总结)

---

## 1. 项目概述

### 1.1 项目简介

Sports Vision Cloud 是一个基于AI的专业运动训练数据可视化平台，专注于羽毛球运动训练分析。

### 1.2 核心功能

| 功能模块 | 描述 |
|---------|------|
| 人体姿态分析 | YOLOv11-Pose 17关键点实时采集与3D可视化 |
| AI训练辅助 | 自动分析用户弱点，动态调整训练参数 |
| 数据可视化 | 实时训练仪表盘、历史数据分析、趋势图表 |
| 设备管理 | 训练设备注册、状态监控、配置管理 |
| 个性化建议 | 基于数据的训练计划和改进建议 |

---

## 2. 技术栈总览

### 2.1 前端技术栈

```
核心框架：React 18.2.0 + TypeScript 5.3.3
构建工具：Vite 5.0.10
UI组件库：Ant Design 5.13.0
图表库：@ant-design/plots 1.2.6
3D渲染：Three.js 0.160.0 + @react-three/fiber 8.15.13
状态管理：Zustand 4.4.7
路由管理：React Router DOM 6.21.1
HTTP客户端：Axios 1.6.5
实时通信：WebSocket (原生API)
```

### 2.2 后端技术栈

```
核心框架：FastAPI 0.109.0
ASGI服务器：Uvicorn 0.27.0
数据验证：Pydantic 2.5.3
MongoDB驱动：Motor 3.3.2 (异步) / PyMongo 4.6.1
时序数据库：InfluxDB-Client 1.40.0
缓存：Redis 5.0.1
认证：Python-Jose 3.3.0 (JWT)
密码处理：Passlib 1.7.4
```

### 2.3 数据库与中间件

| 组件 | 版本 | 用途 |
|------|------|------|
| MongoDB | 7.0 | 业务数据存储（用户、设备、训练会话） |
| InfluxDB | 2.7 | 时序数据存储（姿态数据、实时指标） |
| Redis | 7-alpine | 缓存和会话存储 |

### 2.4 部署技术

```
容器化：Docker + Docker Compose
编排：Kubernetes
前端服务器：Nginx
```

---

## 3. 项目结构

```
sports-vision-cloud/
├── frontend/                    # 前端应用 (React + TypeScript)
│   ├── src/
│   │   ├── components/          # 可复用组件
│   │   │   ├── PoseVisualization3D.tsx    # 3D姿态可视化
│   │   │   ├── RealtimeMetrics.tsx        # 实时指标展示
│   │   │   └── ...
│   │   ├── pages/               # 页面组件
│   │   │   ├── Dashboard.tsx    # 智能仪表盘
│   │   │   ├── Training.tsx     # 实时训练监测
│   │   │   ├── Analysis.tsx     # 数据分析
│   │   │   ├── Devices.tsx      # 设备管理
│   │   │   ├── Settings.tsx     # 系统设置
│   │   │   └── Login.tsx        # 用户登录
│   │   ├── services/            # 服务层
│   │   │   ├── api.ts           # API客户端
│   │   │   └── websocket.ts     # WebSocket客户端
│   │   ├── stores/              # 状态管理
│   │   │   ├── authStore.ts     # 认证状态
│   │   │   ├── trainingStore.ts # 训练状态
│   │   │   └── themeStore.ts    # 主题状态
│   │   ├── App.tsx              # 应用入口
│   │   └── main.tsx             # 渲染入口
│   ├── package.json
│   └── vite.config.ts
│
├── backend/                     # 后端应用 (FastAPI + Python)
│   ├── app/
│   │   ├── api/
│   │   │   └── v1/              # API路由 v1
│   │   │       ├── auth.py      # 认证接口
│   │   │       ├── dashboard.py # 仪表盘接口
│   │   │       ├── training.py  # 训练接口
│   │   │       ├── devices.py   # 设备接口
│   │   │       ├── users.py     # 用户接口
│   │   │       └── websocket.py # WebSocket接口
│   │   ├── core/                # 核心模块
│   │   │   ├── config.py        # 配置管理
│   │   │   ├── database.py      # 数据库连接
│   │   │   └── security.py      # 安全相关
│   │   ├── models/              # 数据模型
│   │   │   ├── user.py
│   │   │   ├── device.py
│   │   │   └── training.py
│   │   ├── services/            # 业务服务层
│   │   │   ├── training_service.py
│   │   │   ├── device_service.py
│   │   │   └── user_service.py
│   │   └── main.py              # 应用入口
│   └── requirements.txt
│
├── k8s/                         # Kubernetes配置
│   ├── namespace.yaml
│   ├── configmaps/
│   ├── deployments/
│   ├── services/
│   └── ingress.yaml
│
├── docker-compose.yml           # Docker编排配置
├── README.md
└── START_GUIDE.md
```

---

## 4. 架构设计

### 4.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Web浏览器     │  │   移动端 App    │  │   Orange Pi设备  │  │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │
└───────────┼─────────────────────┼─────────────────────┼─────────┘
            │ HTTP/WebSocket      │                     │
            ▼                     ▼                     ▼
┌─────────────────────────────────────────────────────────────────┐
│                         API网关层                                │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Nginx / Ingress                       │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────┐
│                         应用服务层                               │
│  ┌─────────────────┐  ┌─────────────────────────────────────┐   │
│  │  前端 (React)   │  │        后端 (FastAPI)               │   │
│  │  - 3D可视化     │  │  - REST API                         │   │
│  │  - 数据图表     │  │  - WebSocket服务                    │   │
│  │  - 状态管理     │  │  - 业务逻辑处理                     │   │
│  └─────────────────┘  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────┐
│                         数据存储层                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  MongoDB    │  │  InfluxDB   │  │   Redis     │             │
│  │  业务数据   │  │  时序数据   │  │   缓存      │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 架构特点

- **前后端分离**：前端React应用独立部署，通过API与后端通信
- **单体应用**：后端为单体架构，所有功能模块在同一服务中
- **多数据库**：MongoDB存储结构化数据，InfluxDB存储时序数据
- **实时通信**：WebSocket支持设备数据实时推送

---

## 5. 前端实现

### 5.1 核心页面功能

#### Dashboard（智能仪表盘）
- 综合击球率仪表盘（Gauge图）
- 疲劳度水波图（Liquid图）
- 击球率与反应时间双轴图（DualAxes）
- 综合能力雷达图（Radar）
- 训练模式分布饼图（Pie）
- 训练频次面积图（Area）

#### Training（实时训练监测）
- 3D人体姿态可视化（Three.js）
- 实时训练指标展示
- 训练计时器
- 双画面姿态对比模式

#### Analysis（数据分析）
- 训练历史记录
- 趋势分析图表
- AI智能分析报告

#### Devices（设备管理）
- 设备列表与状态监控
- 设备配置管理
- 在线/离线状态检测

### 5.2 状态管理设计

```typescript
// authStore - 认证状态
{
  token: string | null,
  user: { id, username, email, nickname, avatar },
  setAuth: (token, user) => void,
  logout: () => void
}

// trainingStore - 训练状态
{
  isTraining: boolean,
  currentSessionId: string,
  realtimeMetrics: {
    hitRate: number,
    reactionTime: number,
    accuracy: number,
    fatigueLevel: number,
    caloriesBurned: number
  },
  poseData: number[][]  // 17关键点坐标
}

// themeStore - 主题状态
{
  theme: 'light' | 'dark'
}
```

### 5.3 3D姿态可视化实现

```typescript
// YOLOv11-Pose 17关键点索引
const KEYPOINT_NAMES = [
  'nose',          // 0: 鼻子
  'left_eye',      // 1: 左眼
  'right_eye',     // 2: 右眼
  'left_ear',      // 3: 左耳
  'right_ear',     // 4: 右耳
  'left_shoulder', // 5: 左肩
  'right_shoulder',// 6: 右肩
  'left_elbow',    // 7: 左肘
  'right_elbow',   // 8: 右肘
  'left_wrist',    // 9: 左腕
  'right_wrist',   // 10: 右腕
  'left_hip',      // 11: 左髋
  'right_hip',     // 12: 右髋
  'left_knee',     // 13: 左膝
  'right_knee',    // 14: 右膝
  'left_ankle',    // 15: 左踝
  'right_ankle'    // 16: 右踝
];

// 骨架连接定义
const POSE_CONNECTIONS = [
  [0, 1], [0, 2], [1, 3], [2, 4],           // 头部
  [5, 6], [5, 7], [7, 9], [6, 8], [8, 10],  // 上肢
  [5, 11], [6, 12], [11, 12],               // 躯干
  [11, 13], [13, 15], [12, 14], [14, 16]    // 下肢
];
```

---

## 6. 后端实现

### 6.1 核心服务层

#### TrainingService（训练服务）

```python
class TrainingService:
    async def start_session(user_id, device_id, mode) -> TrainingSession
    async def end_session(session_id, metrics) -> TrainingSession
    async def save_pose_data(session_id, pose_data) -> None
    async def save_realtime_metrics(session_id, metrics) -> None
    async def get_user_sessions(user_id, days, limit) -> List[TrainingSession]
    async def get_session_stats(user_id, days) -> Dict
    async def get_trend_data(user_id, days) -> List[Dict]
    async def generate_ai_analysis(session_id) -> AIAnalysis
```

#### DeviceService（设备服务）

```python
class DeviceService:
    async def register_device(owner_id, device_data) -> Device
    async def update_status(device_id, status) -> Device
    async def update_config(device_id, config) -> Device
    async def heartbeat(device_id, metrics) -> None
    async def get_user_devices(owner_id) -> List[Device]
    async def count_online_devices() -> int
```

### 6.2 WebSocket连接管理

```python
class ConnectionManager:
    def __init__(self):
        self.user_connections: Dict[str, Set[WebSocket]] = {}
        self.device_connections: Dict[str, WebSocket] = {}

    async def connect_user(user_id: str, websocket: WebSocket)
    async def connect_device(device_id: str, websocket: WebSocket)
    async def disconnect_user(user_id: str, websocket: WebSocket)
    async def disconnect_device(device_id: str)
    async def send_to_user(user_id: str, message: dict)
    async def broadcast_device_data(device_id: str, data: dict)
```

### 6.3 认证机制

```python
# JWT Token配置
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 1440  # 24小时

# Token载荷结构
{
    "sub": user_id,
    "username": username,
    "exp": expiration_time
}

# API保护
@router.get("/protected")
async def protected_route(current_user: User = Depends(get_current_user)):
    return {"user": current_user}
```

---

## 7. 数据模型设计

### 7.1 MongoDB数据模型

#### 用户模型 (users)
```json
{
  "_id": "ObjectId",
  "username": "string (唯一)",
  "email": "string",
  "hashed_password": "string",
  "full_name": "string",
  "role": "user | admin",
  "is_active": "boolean",
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

#### 设备模型 (devices)
```json
{
  "_id": "ObjectId",
  "device_id": "string (如: OP-001)",
  "owner_id": "string",
  "name": "string",
  "type": "orange_pi | depth_camera",
  "status": "online | offline | maintenance",
  "ip_address": "string",
  "firmware_version": "string",
  "config": {
    "ball_speed": "int (10-100)",
    "ball_frequency": "float (0.5-5.0)",
    "spin_type": "string",
    "angle_horizontal": "int (-45~45)",
    "angle_vertical": "int (-30~30)"
  },
  "last_heartbeat": "datetime",
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

#### 训练会话模型 (training_sessions)
```json
{
  "_id": "ObjectId",
  "user_id": "string",
  "device_id": "string",
  "status": "idle | active | paused | completed",
  "start_time": "datetime",
  "end_time": "datetime",
  "duration_seconds": "int",
  "training_mode": "standard | intensive | recovery",
  "metrics": {
    "hit_rate": "float (0-100)",
    "reaction_time": "float (ms)",
    "accuracy": "float (0-100)",
    "fatigue_level": "float (0-100)",
    "calories_burned": "float",
    "total_hits": "int",
    "successful_hits": "int"
  }
}
```

### 7.2 InfluxDB时序数据模型

#### 姿态数据 (pose_data)
```
Measurement: pose_data
Tags:
  - device_id: 设备ID
  - user_id: 用户ID
Fields:
  - confidence: 置信度
  - kp0_x, kp0_y, kp0_z, kp0_v: 关键点0坐标和可见性
  - kp1_x, kp1_y, kp1_z, kp1_v: 关键点1坐标和可见性
  - ... (共17个关键点 × 4个字段 = 68个字段)
Timestamp: 采集时间戳
```

#### 实时训练指标 (training_metrics)
```
Measurement: training_metrics
Tags:
  - user_id: 用户ID
  - session_id: 会话ID
Fields:
  - hit_rate: 击球率
  - reaction_time: 反应时间
  - accuracy: 准确度
  - fatigue_level: 疲劳度
Timestamp: 记录时间戳
```

---

## 8. API接口设计

### 8.1 接口概览

| 模块 | 路径前缀 | 描述 |
|------|----------|------|
| 认证 | `/api/v1/auth` | 用户注册、登录、刷新令牌 |
| 仪表盘 | `/api/v1/dashboard` | 统计数据、概览信息 |
| 训练 | `/api/v1/training` | 训练会话管理、数据上报 |
| 设备 | `/api/v1/devices` | 设备注册、配置、状态管理 |
| 用户 | `/api/v1/users` | 用户信息管理 |
| WebSocket | `/ws` | 实时数据通信 |

### 8.2 认证接口

```
POST /api/v1/auth/register
请求体: { username, email, password }
响应: { code: 0, message: "success", data: { user_id } }

POST /api/v1/auth/login
请求体: { username, password }
响应: { code: 0, data: { access_token, token_type, expires_in } }

POST /api/v1/auth/refresh
响应: { code: 0, data: { access_token, expires_in } }
```

### 8.3 训练接口

```
POST /api/v1/training/sessions/start
请求体: { device_id, mode }
响应: { code: 0, data: { session_id, start_time } }

POST /api/v1/training/sessions/{id}/end
请求体: { metrics }
响应: { code: 0, data: { session } }

GET /api/v1/training/sessions?days=30&limit=100
响应: { code: 0, data: [sessions...] }

GET /api/v1/training/stats?days=7
响应: {
  code: 0,
  data: {
    avg_hit_rate, avg_reaction_time,
    total_sessions, total_training_hours
  }
}

GET /api/v1/training/trends?days=7
响应: { code: 0, data: [{ date, sessions, avg_hit_rate }...] }

GET /api/v1/training/analysis/{session_id}
响应: {
  code: 0,
  data: {
    weaknesses, strengths,
    improvement_suggestions, risk_alerts,
    predicted_progress
  }
}
```

### 8.4 WebSocket接口

```
连接端点:
- 用户端: ws://server/ws/user/{user_id}
- 设备端: ws://server/ws/device/{device_id}

消息类型:
- pose_data: 姿态数据上报（设备→服务器→用户）
- metrics: 实时指标上报
- subscribe_device: 订阅设备数据流
- ping/pong: 心跳检测
```

### 8.5 统一响应格式

```json
{
  "code": 0,           // 状态码，0表示成功
  "message": "success", // 消息描述
  "data": {},          // 数据载荷
  "timestamp": "2025-12-14T10:30:00Z"
}
```

---

## 9. 业务流程

### 9.1 用户登录流程

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  用户   │    │  前端   │    │  后端   │    │ MongoDB │
└────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘
     │              │              │              │
     │ 输入账号密码 │              │              │
     │─────────────>│              │              │
     │              │              │              │
     │              │ POST /login  │              │
     │              │─────────────>│              │
     │              │              │              │
     │              │              │ 查询用户     │
     │              │              │─────────────>│
     │              │              │              │
     │              │              │ 验证密码     │
     │              │              │<─────────────│
     │              │              │              │
     │              │              │ 生成JWT      │
     │              │              │──────┐       │
     │              │              │      │       │
     │              │              │<─────┘       │
     │              │              │              │
     │              │  返回Token   │              │
     │              │<─────────────│              │
     │              │              │              │
     │              │ 存储到       │              │
     │              │ localStorage │              │
     │              │──────┐       │              │
     │              │      │       │              │
     │              │<─────┘       │              │
     │              │              │              │
     │  登录成功    │              │              │
     │<─────────────│              │              │
```

### 9.2 训练会话流程

```
开始训练:
用户点击"开始训练"
  → 选择设备
  → POST /training/sessions/start
  → 创建会话记录(MongoDB)
  → 返回session_id
  → 建立WebSocket连接
  → 订阅设备数据流
  → 开始计时

训练中:
设备(Orange Pi)
  → YOLOv11-Pose检测
  → 提取17关键点
  → WebSocket上报
  → 后端转发给用户
  → 前端更新3D骨架
  → 同步存储到InfluxDB

结束训练:
用户点击"结束训练"
  → POST /training/sessions/{id}/end
  → 提交最终metrics
  → 更新会话状态为"completed"
  → 计算训练时长
  → 关闭WebSocket
```

### 9.3 AI分析生成流程

```
用户请求分析
  → GET /training/analysis/{session_id}
  → 获取近7天训练数据
  → 规则引擎分析:
      击球率 < 60%  → 弱点: "击球回传率偏低"
      反应时间 > 500ms → 弱点: "反应速度需提升"
      准确度 < 70%  → 弱点: "姿态准确度待提高"
      总时长 > 2小时 → 风险: "训练强度过大"
  → 生成分析报告
  → 返回给前端展示
```

---

## 10. 部署方案

### 10.1 Docker Compose（本地开发）

```yaml
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "3000:80"
    depends_on:
      - backend

  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - MONGO_HOST=mongodb
      - INFLUX_URL=http://influxdb:8086
      - REDIS_HOST=redis
    depends_on:
      - mongodb
      - influxdb
      - redis

  mongodb:
    image: mongo:7.0
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db

  influxdb:
    image: influxdb:2.7
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  mongodb_data:
  influxdb_data:
  redis_data:
```

### 10.2 Kubernetes（生产环境）

```
k8s/
├── namespace.yaml           # 命名空间定义
├── configmaps/
│   ├── app-config.yaml      # 应用配置
│   └── secrets.yaml         # 敏感信息
├── deployments/
│   ├── frontend.yaml        # 前端部署（Nginx）
│   ├── backend.yaml         # 后端部署（FastAPI）
│   ├── mongodb.yaml         # MongoDB部署
│   ├── influxdb.yaml        # InfluxDB部署
│   └── redis.yaml           # Redis部署
├── services/
│   └── services.yaml        # 服务暴露
└── ingress.yaml             # 入口控制器
```

### 10.3 启动命令

```bash
# 本地开发 - 前端
cd frontend
npm install
npm run dev

# 本地开发 - 后端
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
python -m uvicorn app.main:app --reload --port 8000

# Docker部署
docker-compose up -d --build

# Kubernetes部署
kubectl apply -f k8s/
```

---

## 11. 项目亮点与总结

### 11.1 技术亮点

| 亮点 | 描述 |
|------|------|
| 现代化技术栈 | React 18 + TypeScript + FastAPI，完整的类型系统 |
| 实时通信 | WebSocket双向数据流，支持断线重连 |
| 3D可视化 | Three.js实现的交互式人体骨架渲染 |
| 时序数据处理 | InfluxDB存储高频采集数据，支持历史查询 |
| 容器化部署 | Docker + K8s，支持弹性伸缩 |
| AI辅助分析 | 基于规则引擎的智能训练建议 |

### 11.2 业务亮点

| 亮点 | 描述 |
|------|------|
| YOLOv11姿态识别 | 17关键点实时追踪，准确率>95% |
| 丰富的数据可视化 | 6种专业图表类型，实时动态更新 |
| 个性化训练建议 | 自动分析弱点，动态调整训练参数 |
| 双画面姿态对比 | 用户姿态与标准动作实时对比评分 |
| 设备远程管理 | 训练设备配置与状态监控 |

### 11.3 数据流向总结

```
设备层(Orange Pi)
    │ YOLOv11-Pose检测
    ▼
WebSocket上报 ──────────────────────────┐
    │                                   │
    ▼                                   ▼
后端(FastAPI) ─────────────────► InfluxDB(时序数据)
    │
    ▼
MongoDB(业务数据) ◄──────────────────────┐
    │                                   │
    ▼                                   │
WebSocket推送                           │
    │                                   │
    ▼                                   │
前端(React) ────► 3D渲染 + 图表展示 ────┘
```

### 11.4 适用场景

- 体育训练数据分析平台
- AI姿态识别技术演示项目
- 实时数据可视化系统学习
- 全栈开发技术参考案例

---

## 附录：核心文件路径

**后端核心文件**：
- `backend/app/main.py` - 应用入口
- `backend/app/core/config.py` - 配置管理
- `backend/app/core/database.py` - 数据库连接
- `backend/app/api/v1/training.py` - 训练API
- `backend/app/api/v1/websocket.py` - WebSocket
- `backend/app/services/training_service.py` - 训练服务

**前端核心文件**：
- `frontend/src/App.tsx` - 应用入口
- `frontend/src/pages/Dashboard.tsx` - 仪表盘
- `frontend/src/pages/Training.tsx` - 训练监测
- `frontend/src/services/api.ts` - API客户端
- `frontend/src/services/websocket.ts` - WebSocket客户端
- `frontend/src/stores/trainingStore.ts` - 训练状态

---

*文档结束*
